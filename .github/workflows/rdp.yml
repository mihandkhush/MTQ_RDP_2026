name: RDP 2026

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RDP_USER: mtqmanik
      RDP_PASS: Manik2200@@

    steps:
    # ---------------- CHECKOUT ----------------
    - name: Checkout Repo
      uses: actions/checkout@v4

    # ---------------- SYSTEM ----------------
    - name: Show System Info
      shell: pwsh
      run: |
        whoami
        systeminfo | findstr /B /C:"OS Name"

    # ---------------- AUTH KEY ----------------
    - name: Read & Consume Tailscale Auth Key
      shell: pwsh
      run: |
        $authFile = "$env:GITHUB_WORKSPACE\auth.txt"
        $usedFile = "$env:GITHUB_WORKSPACE\used.txt"

        if (-not (Test-Path $authFile)) { throw "auth.txt missing" }
        if (-not (Test-Path $usedFile)) { New-Item $usedFile -ItemType File | Out-Null }

        # Read all non-empty lines as strings safely
        $keys = Get-Content $authFile | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }

        if ($keys.Count -eq 0) { throw "No auth key left" }

        # Pick first key
        $key = [string]$keys[0]
        Write-Host "Using Auth Key: $key"
        echo "TS_KEY=$key" >> $env:GITHUB_ENV

        # Save used key
        Add-Content -Path $usedFile -Value $key

        # Remove used key from auth.txt
        $keys | Select-Object -Skip 1 | Set-Content $authFile

    # ---------------- TAILSCALE ----------------
    - name: Install & Login Tailscale
      shell: pwsh
      run: |
        $exe = "$env:ProgramFiles\Tailscale\tailscale.exe"

        if (-not (Test-Path $exe)) {
          Invoke-WebRequest `
            https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi `
            -OutFile tailscale.msi
          Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /quiet /norestart" -Wait
        }

        Start-Service Tailscale
        Start-Sleep 8

        # Reset previous login to avoid invalid key errors
        & $exe logout | Out-Null
        Start-Sleep 3

        & $exe up `
          --authkey="$env:TS_KEY" `
          --hostname="MTQ-RDP" `
          --force-reauth `
          --reset

        for ($i=0; $i -lt 15; $i++) {
          $ip = & $exe ip -4 | Select-Object -First 1
          if ($ip) { break }
          Start-Sleep 3
        }

        if (-not $ip) { throw "Tailscale login failed" }

        echo "TS_IP=$ip" >> $env:GITHUB_ENV
        Write-Host "Tailscale IP: $ip"

    # ---------------- RDP ----------------
    - name: Enable RDP
      shell: pwsh
      run: |
        $sec = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force

        if (-not (Get-LocalUser $env:RDP_USER -ErrorAction SilentlyContinue)) {
          New-LocalUser $env:RDP_USER -Password $sec
          Add-LocalGroupMember Administrators $env:RDP_USER
          Add-LocalGroupMember "Remote Desktop Users" $env:RDP_USER
        }

        Set-ItemProperty `
          "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
          -Name fDenyTSConnections -Value 0

        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    # ---------------- MUMU ----------------
    - name: Download MuMu Player
      shell: pwsh
      run: |
        curl -L -o "C:\Users\mtqmanik\Desktop\MuMuSetup.exe" `
        "https://a11.gdl.netease.com/MuMu_5.0.7_gw-win-download_all_1761811684.exe?n=MuMu_5.0.7_xR9fESC.exe&key1=17d527515c89765ca756ad7419678abe&key2=694d6e16"

    # ---------------- ZIP ----------------
    - name: Download & Extract ZIP
      shell: pwsh
      run: |
        $zip = "C:\Users\mtqmanik\Desktop\myfile.zip"
        $out = "C:\Users\mtqmanik\Desktop\myfile_extracted"

        Invoke-WebRequest `
          -Uri "https://drive.usercontent.google.com/download?id=1OjkZn-dDivUQ2w91FOqp4wVzRwPzTueO&export=download&confirm=t" `
          -OutFile $zip

        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zip, $out)

    # ---------------- KEEP ALIVE ----------------
    - name: Keep Alive
      shell: pwsh
      run: |
        Start-Sleep -Seconds 21600

    - name: DONE
      shell: pwsh
      run: |
        Write-Host "RDP READY"
        Write-Host "IP: $env:TS_IP"
