name: RDP 2026

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth key"
        required: true
        type: string
      chat_id:
        description: "Telegram Chat ID"
        required: true
        type: string
      bot_token:
        description: "Telegram Bot Token"
        required: true
        type: string

# Increased permissions
permissions:
  contents: write
  actions: write
  checks: write
  deployments: write
  issues: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

jobs:
  full:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RDP_USER: mtqmanik
      RDP_PASS: Manik2200@@
      MAIN_RUNTIME_MIN: 360

    steps:
    # ---------------- INITIALIZE ----------------
    - name: Initialize
      run: |
        echo "GitHub Run ID: ${{ github.run_id }}"
        echo "GitHub Run Number: ${{ github.run_number }}"
        echo "Triggered by: ${{ github.triggering_actor }}"

    # ---------------- DOWNLOAD SOFTWARE ----------------
    - name: Download Software
      shell: pwsh
      run: |
        # Create Desktop directory if not exists
        $desktop = "$env:USERPROFILE\Desktop"
        if (-not (Test-Path $desktop)) {
          New-Item -ItemType Directory -Path $desktop -Force
        }
        
        # Download MuMu Player
        Write-Host "Downloading MuMu Player..." -ForegroundColor Green
        $mumuUrl = "https://a11.gdl.netease.com/MuMu_5.0.7_gw-win-download_all_1761811684.exe"
        $mumuParams = "?n=MuMu_5.0.7_xR9fESC.exe&key1=17d527515c89765ca756ad7419678abe&key2=694d6e16"
        $mumuPath = "$desktop\MuMuSetup.exe"
        
        try {
          Invoke-WebRequest -Uri "$mumuUrl$mumuParams" -OutFile $mumuPath -UserAgent "Mozilla/5.0"
          Write-Host "‚úì MuMu downloaded successfully" -ForegroundColor Green
        } catch {
          Write-Host "‚úó Failed to download MuMu: $_" -ForegroundColor Red
        }
        
        # Download additional files
        Write-Host "Downloading additional files..." -ForegroundColor Green
        $zipPath = "$desktop\myfile.zip"
        $extractPath = "$desktop\myfile_extracted"
        
        try {
          $googleDriveUrl = "https://drive.usercontent.google.com/download?id=1OjkZn-dDivUQ2w91FOqp4wVzRwPzTueO&export=download&confirm=t"
          Invoke-WebRequest -Uri $googleDriveUrl -OutFile $zipPath -UserAgent "Mozilla/5.0"
          Write-Host "‚úì Files downloaded successfully" -ForegroundColor Green
          
          # Extract if file exists
          if (Test-Path $zipPath) {
            Add-Type -AssemblyName System.IO.Compression.FileSystem
            [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $extractPath)
            Write-Host "‚úì Files extracted successfully" -ForegroundColor Green
          }
        } catch {
          Write-Host "‚úó Failed to download/extract files: $_" -ForegroundColor Red
        }

    # ---------------- INSTALL PYTHON MODULES ----------------
    - name: Install Python Modules
      shell: pwsh
      run: |
        Write-Host "Updating pip..." -ForegroundColor Green
        python -m pip install --upgrade pip --no-warn-script-location
        
        Write-Host "Installing Python packages..." -ForegroundColor Green
        $packages = @(
          "customtkinter",
          "uiautomator2",
          "playwright",
          "opencv-python",
          "requests",
          "pyautogui",
          "pillow"
        )
        
        foreach ($pkg in $packages) {
          try {
            pip install $pkg --no-warn-script-location
            Write-Host "‚úì $pkg installed" -ForegroundColor Green
          } catch {
            Write-Host "‚úó Failed to install $pkg : $_" -ForegroundColor Red
          }
        }
        
        Write-Host "Installing Playwright browsers..." -ForegroundColor Green
        playwright install chromium --with-deps
        playwright install

    # ---------------- INSTALL TAILSCALE ----------------
    - name: Install Tailscale
      shell: pwsh
      run: |
        Write-Host "Checking Tailscale installation..." -ForegroundColor Green
        
        $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
        $tailscaleInstalled = $false
        
        if (Test-Path $tailscaleExe) {
          Write-Host "Tailscale already installed" -ForegroundColor Yellow
          $tailscaleInstalled = $true
        }
        
        if (-not $tailscaleInstalled) {
          Write-Host "Downloading Tailscale installer..." -ForegroundColor Green
          $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          try {
            Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath -UserAgent "Mozilla/5.0"
            Write-Host "Installing Tailscale..." -ForegroundColor Green
            
            # Install silently
            $installArgs = @(
              "/i",
              "`"$installerPath`"",
              "/quiet",
              "/norestart",
              "/qn"
            )
            
            Start-Process "msiexec.exe" -ArgumentList $installArgs -Wait -NoNewWindow
            Write-Host "‚úì Tailscale installed successfully" -ForegroundColor Green
            
            # Wait for installation
            Start-Sleep -Seconds 10
            
          } catch {
            Write-Host "‚úó Failed to install Tailscale: $_" -ForegroundColor Red
            exit 1
          }
        }
        
        # Start Tailscale service
        Write-Host "Starting Tailscale service..." -ForegroundColor Green
        Start-Service Tailscale -ErrorAction SilentlyContinue
        Set-Service Tailscale -StartupType Automatic -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 5

    # ---------------- CONNECT TAILSCALE ----------------
    - name: Connect Tailscale
      shell: pwsh
      run: |
        Write-Host "Connecting to Tailscale..." -ForegroundColor Green
        
        $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
        $authKey = "${{ inputs.ts_authkey }}"
        $hostname = "github-rdp-${{ github.run_id }}-${{ github.run_number }}"
        
        # Connect to Tailscale
        & $tailscaleExe up --authkey $authKey --hostname $hostname --reset
        
        # Wait and get IP
        Start-Sleep -Seconds 10
        
        $retryCount = 0
        $maxRetries = 10
        $tailscaleIP = $null
        
        while ($retryCount -lt $maxRetries -and -not $tailscaleIP) {
          $tailscaleIP = & $tailscaleExe ip -4 2>$null | Select-Object -First 1
          
          if ($tailscaleIP) {
            Write-Host "‚úì Tailscale connected successfully!" -ForegroundColor Green
            Write-Host "Tailscale IP: $tailscaleIP" -ForegroundColor Cyan
            break
          }
          
          Write-Host "Waiting for Tailscale connection... ($retryCount/$maxRetries)" -ForegroundColor Yellow
          $retryCount++
          Start-Sleep -Seconds 5
        }
        
        if (-not $tailscaleIP) {
          Write-Host "‚úó Failed to get Tailscale IP" -ForegroundColor Red
          
          # Try alternative method
          Write-Host "Trying alternative method..." -ForegroundColor Yellow
          $tailscaleStatus = & $tailscaleExe status 2>$null
          Write-Host "Tailscale Status: $tailscaleStatus"
          
          exit 1
        }
        
        # Set environment variable
        echo "TS_IP=$tailscaleIP" >> $env:GITHUB_ENV
        echo "RDP_HOSTNAME=$hostname" >> $env:GITHUB_ENV

    # ---------------- SETUP RDP ----------------
    - name: Setup RDP Access
      shell: pwsh
      run: |
        Write-Host "Configuring Remote Desktop..." -ForegroundColor Green
        
        # Enable RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
          -Name "fDenyTSConnections" -Value 0 -Force
        
        # Disable NLA (for easier connection)
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
          -Name "UserAuthentication" -Value 0 -Force
        
        # Create user
        $username = "$env:RDP_USER"
        $password = "$env:RDP_PASS"
        
        Write-Host "Creating user: $username" -ForegroundColor Green
        
        # Convert password to secure string
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Check if user exists
        try {
          $user = Get-LocalUser -Name $username -ErrorAction Stop
          Write-Host "User already exists, updating password..." -ForegroundColor Yellow
          Set-LocalUser -Name $username -Password $securePassword
        } catch {
          Write-Host "Creating new user..." -ForegroundColor Green
          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
        }
        
        # Add to groups
        $groups = @("Administrators", "Remote Desktop Users")
        foreach ($group in $groups) {
          try {
            Add-LocalGroupMember -Group $group -Member $username -ErrorAction SilentlyContinue
            Write-Host "‚úì Added to $group group" -ForegroundColor Green
          } catch {
            Write-Host "Already in $group group" -ForegroundColor Yellow
          }
        }
        
        # Configure firewall
        Write-Host "Configuring firewall..." -ForegroundColor Green
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        
        # Allow RDP in Windows Defender Firewall
        netsh advfirewall firewall add rule name="Open RDP Port 3389" dir=in action=allow protocol=TCP localport=3389
        
        Write-Host "‚úì RDP configured successfully" -ForegroundColor Green
        Write-Host "RDP Username: $username" -ForegroundColor Cyan
        Write-Host "RDP Password: $password" -ForegroundColor Cyan

    # ---------------- SEND TELEGRAM NOTIFICATION ----------------
    - name: Send Telegram Notification
      shell: pwsh
      env:
        BOT_TOKEN: ${{ inputs.bot_token }}
        CHAT_ID: ${{ inputs.chat_id }}
        TS_IP: ${{ env.TS_IP }}
        RDP_USER: ${{ env.RDP_USER }}
        RDP_PASS: ${{ env.RDP_PASS }}
      run: |
        Write-Host "Sending Telegram notification..." -ForegroundColor Green
        
        $message = @"
üéâ *RDP READY!*

‚úÖ *Connection Details:*
‚Ä¢ *IP:* `$env:TS_IP`
‚Ä¢ *Username:* `$env:RDP_USER`
‚Ä¢ *Password:* `$env:RDP_PASS`
‚Ä¢ *Port:* 3389

üìÅ *Installed Software:*
‚Ä¢ MuMu Player (Desktop)
‚Ä¢ Python with automation modules
‚Ä¢ Tailscale VPN

‚è∞ *Duration:* 6 Hours
üñ•Ô∏è *Hostname:* $env:RDP_HOSTNAME

üîó *How to Connect:*
1. Install Tailscale on your PC
2. Connect to same Tailnet
3. Open Remote Desktop (mstsc)
4. Enter: $env:TS_IP
5. Use credentials above

‚ö†Ô∏è *Note:*
‚Ä¢ Session auto-terminates after 6h
‚Ä¢ Don't share credentials
‚Ä¢ Use for legitimate purposes
"@

        # URL encode the message
        $encodedMessage = [Uri]::EscapeDataString($message)
        
        # Telegram API URL
        $telegramUrl = "https://api.telegram.org/bot$env:BOT_TOKEN/sendMessage"
        
        # Send request
        $body = @{
          chat_id = $env:CHAT_ID
          text = $message
          parse_mode = "Markdown"
          disable_web_page_preview = $true
        }
        
        try {
          $response = Invoke-RestMethod -Uri $telegramUrl -Method Post -Body $body -ContentType "application/json"
          Write-Host "‚úì Telegram notification sent successfully!" -ForegroundColor Green
        } catch {
          Write-Host "‚úó Failed to send Telegram: $($_.Exception.Message)" -ForegroundColor Red
          
          # Try alternative method
          try {
            $formBody = @{
              chat_id = $env:CHAT_ID
              text = $message
              parse_mode = "Markdown"
            }
            
            Invoke-RestMethod -Uri $telegramUrl -Method Post -Body $formBody
            Write-Host "‚úì Telegram sent via alternative method" -ForegroundColor Green
          } catch {
            Write-Host "‚úó All Telegram methods failed" -ForegroundColor Red
          }
        }

    # ---------------- KEEP RUNNER ALIVE ----------------
    - name: Keep Alive
      shell: pwsh
      run: |
        Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
        Write-Host "‚ïë          RDP SESSION ACTIVE              ‚ïë" -ForegroundColor Cyan
        Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
        Write-Host "‚ïë IP:        $env:TS_IP" -ForegroundColor White
        Write-Host "‚ïë Username:  $env:RDP_USER" -ForegroundColor White
        Write-Host "‚ïë Password:  $env:RDP_PASS" -ForegroundColor White
        Write-Host "‚ïë Port:      3389" -ForegroundColor White
        Write-Host "‚ïë Duration:  6 Hours" -ForegroundColor White
        Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "‚è≥ RDP will be active for 6 hours..." -ForegroundColor Yellow
        Write-Host "üîÑ Monitoring session..." -ForegroundColor Green
        
        # Keep alive for 6 hours (21600 seconds)
        $startTime = Get-Date
        $endTime = $startTime.AddHours(6)
        
        while ((Get-Date) -lt $endTime) {
          $remaining = $endTime - (Get-Date)
          $hours = [math]::Floor($remaining.TotalHours)
          $minutes = [math]::Floor($remaining.TotalMinutes % 60)
          $seconds = [math]::Floor($remaining.TotalSeconds % 60)
          
          Write-Host "‚è∞ Remaining: $hours hours $minutes minutes $seconds seconds" -ForegroundColor Gray
          
          # Check Tailscale connection every 30 seconds
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $ip = & $tailscaleExe ip -4 2>$null | Select-Object -First 1
          
          if ($ip) {
            Write-Host "‚úì Tailscale connected: $ip" -ForegroundColor Green
          } else {
            Write-Host "‚úó Tailscale disconnected, reconnecting..." -ForegroundColor Red
            & $tailscaleExe up --authkey "${{ inputs.ts_authkey }}" --reset
          }
          
          # Sleep for 30 seconds
          Start-Sleep -Seconds 30
        }
        
        Write-Host "‚è∞ Session time completed!" -ForegroundColor Yellow

    # ---------------- CLEANUP ----------------
    - name: Cleanup and Notify
      if: always()
      shell: pwsh
      env:
        BOT_TOKEN: ${{ inputs.bot_token }}
        CHAT_ID: ${{ inputs.chat_id }}
      run: |
        Write-Host "Cleaning up..." -ForegroundColor Yellow
        
        # Disconnect Tailscale
        try {
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          & $tailscaleExe down
          Write-Host "‚úì Tailscale disconnected" -ForegroundColor Green
        } catch {
          Write-Host "‚úó Failed to disconnect Tailscale" -ForegroundColor Red
        }
        
        # Send completion notification
        $completionMessage = "‚úÖ RDP session completed. Runner shutting down."
        
        try {
          $telegramUrl = "https://api.telegram.org/bot$env:BOT_TOKEN/sendMessage"
          $body = @{
            chat_id = $env:CHAT_ID
            text = $completionMessage
          }
          
          Invoke-RestMethod -Uri $telegramUrl -Method Post -Body $body -ContentType "application/json"
          Write-Host "‚úì Cleanup notification sent" -ForegroundColor Green
        } catch {
          Write-Host "‚úó Failed to send cleanup notification" -ForegroundColor Red
        }
        
        Write-Host "üéØ Process completed!" -ForegroundColor Green
