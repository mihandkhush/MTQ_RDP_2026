name: RDP 2026

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth key"
        required: true
        type: string
      chat_id:
        description: "Telegram Chat ID for notifications"
        required: true
        type: string
      bot_token:
        description: "Telegram Bot Token"
        required: true
        type: string
      cycles:
        description: "Number of cycles"
        required: false
        default: "1"
        type: string

permissions:
  contents: read
  actions: write

jobs:
  full:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RDP_USER: mtqmanik
      RDP_PASS: Manik2200@@
      MAIN_RUNTIME_MIN: 360

    steps:
    # ---------------- BASIC ----------------
    - name: Show runner info
      shell: pwsh
      run: |
        whoami
        systeminfo | findstr /B /C:"OS Name"
        hostname

    # ---------------- INSTALL SOFTWARE ----------------
    - name: Download and Install Software
      shell: pwsh
      run: |
        # Download MuMu Player
        Write-Host "Downloading MuMu Player..."
        $mumuPath = "$env:USERPROFILE\Desktop\MuMuSetup.exe"
        Invoke-WebRequest -Uri "https://a11.gdl.netease.com/MuMu_5.0.7_gw-win-download_all_1761811684.exe?n=MuMu_5.0.7_xR9fESC.exe&key1=17d527515c89765ca756ad7419678abe&key2=694d6e16" -OutFile $mumuPath
        
        # Download and extract additional files
        Write-Host "Downloading additional files..."
        $zipPath = "$env:USERPROFILE\Desktop\myfile.zip"
        $extractPath = "$env:USERPROFILE\Desktop\myfile_extracted"
        
        Invoke-WebRequest -Uri "https://drive.usercontent.google.com/download?id=1OjkZn-dDivUQ2w91FOqp4wVzRwPzTueO&export=download&confirm=t&uuid=ba3fa931-9599-4946-81e6-ebbbf490ee7f" -OutFile $zipPath
        
        # Extract zip file
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $extractPath)
        
        Write-Host "Software installation completed!"

    # ---------------- PYTHON MODULES ----------------
    - name: Install Python modules
      shell: pwsh
      run: |
        Write-Host "Installing Python modules..."
        python -m pip install --upgrade pip
        pip install customtkinter uiautomator2 playwright opencv-python requests pytelegrambotapi
        
        # Install Playwright browsers
        playwright install
        playwright install-deps

    # ---------------- TAILSCALE ----------------
    - name: Install and Start Tailscale
      shell: pwsh
      run: |
        Write-Host "Installing Tailscale..."
        $exe = "$env:ProgramFiles\Tailscale\tailscale.exe"

        if (-not (Test-Path $exe)) {
          Invoke-WebRequest `
            https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi `
            -OutFile tailscale.msi
          Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /quiet /norestart" -Wait
        }

        # Start Tailscale service
        Start-Service Tailscale
        Start-Sleep 10

        # Connect to Tailscale
        & $exe up --authkey "${{ inputs.ts_authkey }}" --hostname "github-rdp-${{ github.run_id }}"

        # Get Tailscale IP
        Start-Sleep 5
        $ip = & $exe ip -4 | Select-Object -First 1
        
        if (-not $ip) {
          for ($i=0; $i -lt 10; $i++) {
            $ip = & $exe ip -4 | Select-Object -First 1
            if ($ip) { break }
            Start-Sleep 3
          }
        }

        if (-not $ip) { throw "Tailscale IP not found" }

        echo "TS_IP=$ip" >> $env:GITHUB_ENV
        Write-Host "Tailscale IP: $ip"

    # ---------------- RDP CONFIGURATION ----------------
    - name: Enable RDP
      shell: pwsh
      run: |
        Write-Host "Configuring RDP..."
        $sec = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force

        # Create user if not exists
        if (-not (Get-LocalUser $env:RDP_USER -ErrorAction SilentlyContinue)) {
          New-LocalUser $env:RDP_USER -Password $sec
          Add-LocalGroupMember Administrators $env:RDP_USER
          Add-LocalGroupMember "Remote Desktop Users" $env:RDP_USER
        }

        # Enable RDP
        Set-ItemProperty `
          "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
          -Name fDenyTSConnections -Value 0

        # Enable firewall rules
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        Write-Host "RDP Enabled Successfully!"

    # ---------------- SEND INFO TO TELEGRAM ----------------
    - name: Send RDP details to Telegram
      shell: pwsh
      env:
        BOT_TOKEN: ${{ inputs.bot_token }}
        CHAT_ID: ${{ inputs.chat_id }}
      run: |
        $message = @"
üéâ *RDP Setup Completed Successfully!*

üì± *Connection Details:*
‚Ä¢ *IP Address:* `$env:TS_IP`
‚Ä¢ *Username:* `$env:RDP_USER`
‚Ä¢ *Password:* `$env:RDP_PASS`
‚Ä¢ *RDP Port:* 3389

üí° *How to Connect:*
1. Install Tailscale on your PC
2. Connect to your Tailnet
3. Use Remote Desktop Connection
4. Enter the IP address above
5. Use the credentials provided

‚ö†Ô∏è *Note:* This RDP will be active for 6 hours
üîÑ *Runner:* $env:COMPUTERNAME
"@

        # Send message via Telegram Bot API
        $url = "https://api.telegram.org/bot$env:BOT_TOKEN/sendMessage"
        $body = @{
          chat_id = $env:CHAT_ID
          text = $message
          parse_mode = "Markdown"
        } | ConvertTo-Json

        Invoke-RestMethod -Uri $url -Method Post -ContentType "application/json" -Body $body
        
        Write-Host "RDP details sent to Telegram!"

    # ---------------- KEEP ALIVE ----------------
    - name: Keep alive (6 hours)
      shell: pwsh
      run: |
        Write-Host "RDP is now active for 6 hours..."
        Write-Host "IP: $env:TS_IP"
        Write-Host "Username: $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
        
        # Keep the runner alive for 6 hours
        Start-Sleep -Seconds 21600

    # ---------------- CLEANUP ----------------
    - name: Cleanup and notify
      shell: pwsh
      env:
        BOT_TOKEN: ${{ inputs.bot_token }}
        CHAT_ID: ${{ inputs.chat_id }}
      if: always()
      run: |
        Write-Host "Cleaning up..."
        
        # Send completion message
        $message = "‚è∞ RDP Session Completed. Runner shutting down."
        $url = "https://api.telegram.org/bot$env:BOT_TOKEN/sendMessage"
        $body = @{
          chat_id = $env:CHAT_ID
          text = $message
        } | ConvertTo-Json
        
        try {
          Invoke-RestMethod -Uri $url -Method Post -ContentType "application/json" -Body $body
        } catch {
          Write-Host "Failed to send cleanup notification"
        }
        
        Write-Host "DONE"
