name: RDP 2026

on:
  workflow_dispatch:
    inputs:
      run_rdp:
        description: "Click to run RDP"
        required: true
        default: "yes"
      cycles:
        description: "Number of cycles"
        required: false
        default: "1"

permissions:
  contents: read
  actions: write

jobs:
  full:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RDP_USER: mtqmanik
      RDP_PASS: Manik2200@@
      MAIN_RUNTIME_MIN: 360
      AUTH_FILE: auth.txt
      USED_FILE: used.txt
      MUMU_PATH: "C:\\Users\\mtqmanik\\Desktop\\MuMuSetup.exe"
      ZIP_PATH: "C:\\Users\\mtqmanik\\Desktop\\myfile.zip"
      EXTRACT_PATH: "C:\\Users\\mtqmanik\\Desktop\\myfile_extracted"

    steps:
    - name: Show runner info
      shell: pwsh
      run: |
        whoami
        systeminfo | findstr /B /C:"OS Name"

    - name: Read Auth Key
      shell: pwsh
      run: |
        $allKeys = Get-Content $env:AUTH_FILE
        $usedKeys = @()
        if (Test-Path $env:USED_FILE) { $usedKeys = Get-Content $env:USED_FILE }

        $key = $allKeys | Where-Object { $_ -and ($_ -notin $usedKeys) } | Select-Object -First 1
        if (-not $key) { throw "No unused auth key found!" }

        echo "TS_KEY=$key" >> $env:GITHUB_ENV
        Write-Host "Using Auth Key: $key"

    - name: Install and Start Tailscale
      shell: pwsh
      run: |
        $exe = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (-not (Test-Path $exe)) {
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile tailscale.msi
          Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /quiet /norestart" -Wait
        }

        Start-Service Tailscale
        Start-Sleep 10
        & $exe up --authkey "$env:TS_KEY" --hostname "bullet"

        for ($i=0; $i -lt 10; $i++) {
          $ip = & $exe ip -4 | Select-Object -First 1
          if ($ip) { break }
          Start-Sleep 3
        }

        if (-not $ip) { throw "Tailscale IP not found" }
        echo "TS_IP=$ip" >> $env:GITHUB_ENV
        Write-Host "Tailscale IP: $ip"

    - name: Mark key as used
      shell: pwsh
      run: |
        Add-Content -Path $env:USED_FILE -Value $env:TS_KEY

    - name: Enable RDP
      shell: pwsh
      run: |
        $sec = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force
        if (-not (Get-LocalUser $env:RDP_USER -EA SilentlyContinue)) {
          New-LocalUser $env:RDP_USER -Password $sec
          Add-LocalGroupMember Administrators $env:RDP_USER
          Add-LocalGroupMember "Remote Desktop Users" $env:RDP_USER
        }

        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Download MuMu Player
      shell: pwsh
      run: |
        curl -L -o $env:MUMU_PATH "https://a11.gdl.netease.com/MuMu_5.0.7_gw-win-download_all_1761811684.exe?n=MuMu_5.0.7_xR9fESC.exe&key1=17d527515c89765ca756ad7419678abe&key2=694d6e16"

    - name: Download & Extract ZIP
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://drive.usercontent.google.com/download?id=1OjkZn-dDivUQ2w91FOqp4wVzRwPzTueO&export=download&confirm=t&uuid=ba3fa931-9599-4946-81e6-ebbbf490ee7f" -OutFile $env:ZIP_PATH
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($env:ZIP_PATH, $env:EXTRACT_PATH)

    - name: Install Python Modules
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter uiautomator2 opencv-python playwright
        py -m playwright install

    - name: Keep alive
      shell: pwsh
      run: |
        Start-Sleep -Seconds 21600

    - name: Done
      shell: pwsh
      run: |
        Write-Host "DONE"
        Write-Host "RDP IP: $env:TS_IP"
